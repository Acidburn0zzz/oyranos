
CC=cc
CXX=c++
COLLECT = ar cru
RANLIB = ranlib
LNK = ln -s
RM = rm -vf
INSTALL = install -v
RPMARCH = `rpmbuild --showrc | awk '/^build arch/ {print $$4}'`

exec_prefix	= ${prefix}
bindir		= ${exec_prefix}/bin
datadir		= ${prefix}/share
includedir	= ${prefix}/include
libdir		= ${prefix}$(LIB)
mandir		= ${prefix}/man
srcdir		= .
colordir        = /usr/share/color

LIBSONAMEFULL = lib$(TARGET)$(SO).$(VERSION)
LIBSONAME = lib$(TARGET)$(SO).$(VERSION_A)
LIBSO = lib$(TARGET)$(SO)
LIBNAME = lib$(TARGET).a
LIB_MONI_SONAMEFULL = lib$(TARGET)_moni$(SO).$(VERSION)
LIB_MONI_SONAME = lib$(TARGET)_moni$(SO).$(VERSION_A)
LIB_MONI_SO = lib$(TARGET)_moni$(SO)
LIB_MONI_NAME = lib$(TARGET)_moni.a
LIB_XNVCTRL = libXNVCtrl
LIB_XNVCTRL_NAME = $(LIB_XNVCTRL).a

DL = --ldflags # --ldstaticflags


INCL= -I/usr/include -I$(includedir) -I/usr/X11R6/include -I$(srcdir) \
	$(PNG_H) $(ELEKTRA_H) $(X_H)
CXXFLAGS=$(OPTS) $(INCL) $(FLU_H)
CFLAGS = $(OPTS) $(INCL)

ELEKTRA_LIBS = `test -f /usr$(LIB)/libelektra.a && echo /usr$(LIB)/libelektra.a /usr$(LIB)/libelektra_default.a || echo -lelektra`


LDLIBS = -L$(libdir) -L. \
	$(ELEKTRA_LIBS) -lc


CPP_HEADERS = \
	$(TARGET).h \
	$(TARGET)_config.h \
	$(TARGET)_debug.h \
	$(TARGET)_definitions.h \
	$(TARGET)_helper.h \
	$(TARGET)_internal.h \
	$(TARGET)_monitor.h \
	$(TARGET)_monitor_internal.h
#	fl_$(TARGET).h
CFILES = \
	$(TARGET).c \
	$(TARGET)_helper.c
CFILESC = \
	$(TARGET)_debug.c
CFILES_MONI = \
	$(TARGET)_monitor.c
CFILES_MONI_NVIDIA = \
	$(TARGET)_monitor_nvidia.c
CFILES_GAMMA = \
	$(TARGET)_gamma.c

CXXFILES_FLTK = \
	$(TARGET)_config_fltk.cxx
CPPFILES_FLU = \
	$(TARGET)_config_flu.cpp

CPPFILES =
CXXFILES =
#	fl_oyranos.cxx
DATA = \
	$(TARGET)_logo.png
DOKU = \
        AUTHORS \
        ChangeLog \
        COPYING \
        README \
		Doxyfile \
		doxymentation

FLUID = \
	oyranos_config_fltk.fl

SOURCES = $(CPPFILES) $(CXXFILES) $(CPP_HEADERS) $(CFILES) $(CFILESC) \
		$(CFILES_MONI) $(CFILES_MONI_NVIDIA) $(CFILES_GAMMA) \
		$(CPPFILES_FLU) test.c test2.cpp
OBJECTS = $(CPPFILES:.cpp=.o) $(CXXFILES:.cxx=.o) $(CFILES:.c=.o) $(CFILESC:.c=.o)
MONI_OBJECTS = $(CPPFILES_MONI:.cpp=.o) $(CXXFILESMONI:.cxx=.o) $(CFILES_MONI:.c=.o)
FLTK_OBJECTS = $(CXXFILES_FLTK:.cxx=.o)
FLU_OBJECTS = $(CPPFILES_FLU:.cpp=.o) $(CXXFILES_FLU:.cxx=.o) \
				$(CFILES_FLU:.c=.o)

INCL_DEP = $(INCL) $(SOURCES)

#.SILENT:

TEST2 = test2

STD_PROFILES = base eci

ALL_FILES = \
	$(DATA) \
	$(DOKU) \
	configure \
	configure.sh \
	makefile.in \
	$(TARGET).pc.in \
	$(TARGET)_monitor.pc.in \
	$(TARGET).spec.in \
	$(TARGET)-config.in \
	$(SOURCES) \
	$(FLUID)

# build all what is needed to run the libraries, helpers and the examples
all:	mkdepend $(LIB_MONI_SONAMEFULL) \
	$(TARGET)-monitor $(TARGET)-monitor-nvidia \
	$(FLTK_GUI) $(FLU_GUI) $(TEST2)
	cd standard_profiles; \
	for prof in $(STD_PROFILES); do \
	     test $${prof} && \
	         echo -e "$${prof} profiles will be included" || \
	         echo -e "$${prof} profile directory is not found - ignoring"; \
	done;

# MTIME   := $(shell find $(TIMEDIR) -prune -printf %Ty%Tm%Td.%TT | sed s/\://g)

# this is a test
time:
	echo $(MTIME)

# build all objects and libraries, link the headers to $(TARGET)
$(LIBSONAMEFULL):	$(OBJECTS) $(LIBNAME)
	echo Linking $@ ...
	$(CC) $(OPTS) $(LINK_FLAGS) $(LINK_NAME) -o $(LIBSONAMEFULL) \
	$(OBJECTS) \
	-L$(LIB) $(LDLIBS)
	$(RM)  $(LIBSONAME)
	$(LNK) $(LIBSONAMEFULL) $(LIBSONAME)
	$(RM)  $(LIBSO)
	$(LNK) $(LIBSONAMEFULL) $(LIBSO)

# the monitor library
$(LIB_MONI_SONAMEFULL):	$(MONI_OBJECTS) $(LIB_MONI_NAME) $(LIBSONAMEFULL)
	echo Linking $@ ...
	$(CC) $(OPTS) $(LINK_FLAGS) $(LINK_NAME_M) $(LIBSONAMEFULL) \
	-o $(LIB_MONI_SONAMEFULL) \
	$(MONI_OBJECTS) $(X11_LIBS) $(LDLIBS)
	$(RM)  $(LIB_MONI_SONAME)
	$(LNK) $(LIB_MONI_SONAMEFULL) $(LIB_MONI_SONAME)
	$(RM)  $(LIB_MONI_SO)
	$(LNK) $(LIB_MONI_SONAMEFULL) $(LIB_MONI_SO)

$(LIB_XNVCTRL).a:
	echo Building $@ ...
	-(cd $(LIB_XNVCTRL) && $(MAKE))
	test -L $(LIB_XNVCTRL).a || $(LNK) $(LIB_XNVCTRL)/$(LIB_XNVCTRL).a .

# the twinview library
$(TARGET)-monitor-nvidia:	$(LIB_XNVCTRL).a
	echo Linking $@ ...
	$(CC) $(OPTS) $(INCL) $(TARGET)_monitor_nvidia.c -I./$(LIB_XNVCTRL) \
	-o $(TARGET)-monitor-nvidia -L./   $(LDLIBS) $(X11_LIBS) \
	-L./$(LIB_XNVCTRL) -lXNVCtrl $(LIBSONAMEFULL) $(LIB_MONI_SONAMEFULL)

$(target)_config_fltk.o:	$(TARGET)_config_fltk.cxx
	$(CXX) -I.. $(CXXFLAGS) $(FLTK_H) -c $<

# general configuration tool example
$(TARGET)-config-fltk:	$(FLTK_OBJECTS)
	echo Linking $@ ...
	$(CXX) $(OPTS) -o $(TARGET)-config-fltk \
	$(FLTK_OBJECTS) \
	$(LIBSONAMEFULL) $(LIB_MONI_SONAMEFULL) $(LINK_LIB_PATH) \
	$(FLTK_LIBS) $(LDLIBS) $(PNG_LIBS)
	$(REZ)


$(TARGET)-config-flu:	$(LIBSONAMEFULL) $(LIB_MONI_SONAMEFULL) $(FLU_OBJECTS)
	echo Linking $@ ...
	-$(CXX) $(OPTS) -o $(TARGET)-config-flu \
	$(TARGET)_config_flu.o \
	$(LIBSONAMEFULL) $(LIB_MONI_SONAMEFULL) $(LINK_LIB_PATH) \
	$(FLU_LIBS) $(FLTK_LIBS) $(LDLIBS) $(PNG_LIBS)
	$(REZ)


$(TARGET)-config-flu-static:	$(LIBSONAMEFULL) $(FLU_OBJECTS)
	echo Linking static $(TARGET)-config-flu ...
	$(CXX) -Wall -O3 -o $(TARGET)-config-flu $(TARGET)_config_flu.o \
	$(LIBNAME) $(LIB_MONI_NAME) $(LINK_LIB_PATH) \
	`flu-config --ldstaticflags` \
	`fltk-config --use-images --ldstaticflags` \
	-L/usr/X11R6$(LIB) \
	`test -f /usr$(LIB)/libelektra.a && echo /usr$(LIB)/libelektra.a || echo -lelektra` -lsupc++ $(PNG_LIBS)
	#strip $(TARGET)-config-flu
	$(REZ)

$(LIBNAME):	$(OBJECTS)
	echo Linking $@ ...
	$(COLLECT) $(LIBNAME) $(OBJECTS)
	$(RANLIB) $(LIBNAME)

$(LIB_MONI_NAME):	$(MONI_OBJECTS)
	echo Linking $@ ...
	$(COLLECT) $(LIB_MONI_NAME) $(MONI_OBJECTS)
	$(RANLIB) $(LIB_MONI_NAME)

# the monitor profile tool
$(TARGET)-monitor:	$(LIBSONAMEFULL) $(LIB_MONI_SONAMEFULL) $(TARGET)_gamma.o
	echo Linking $@ ...
	$(CC) $(OPTS) -o $(TARGET)-monitor \
	$(TARGET)_gamma.o \
	$(LIBSONAMEFULL) $(LIB_MONI_SONAMEFULL) $(LINK_LIB_PATH) \
	$(LDLIBS)

test2:	$(LIB_MONI_SONAMEFULL) test2.o
	echo Linking $@ ...
	$(CXX) $(OPTS) -o test2 \
	test2.o \
	$(LIB_MONI_SONAMEFULL) $(LINK_SRC_PATH) \
	$(LIBSONAMEFULL) $(LDLIBS) -l$(TARGET)
test:	test.o
	$(CC) $(OPTS) -o test \
	test.o \
	$(LIBSONAMEFULL) $(LINK_SRC_PATH) \
	$(LDLIBS) 

doc:
	echo Documentation ...
	test -n 'which doxygen' && doxygen Doxyfile || echo "Will not create Documentation because doxygen is missing"
	echo ... Documentation done

# the copy part for this directory level
install-main:	all doc
	echo Installing ...
	-$(MAKE) uninstall
	mkdir -p $(DESTDIR)$(bindir)
	$(INSTALL) -m 755 $(TARGET)-config     $(DESTDIR)$(bindir)
	$(INSTALL) -m 755 $(TARGET)-monitor    $(DESTDIR)$(bindir)
	-$(INSTALL) -m 755 $(TARGET)-monitor-nvidia $(DESTDIR)$(bindir)
	mkdir -p $(DESTDIR)$(libdir)
	mkdir -p $(DESTDIR)$(libdir)/pkgconfig
	$(INSTALL) -m 755 $(TARGET).pc         $(DESTDIR)$(libdir)/pkgconfig/
	$(INSTALL) -m 755 $(TARGET)_monitor.pc $(DESTDIR)$(libdir)/pkgconfig/
	$(INSTALL) -m 644 $(LIBNAME) $(DESTDIR)$(libdir)
	$(INSTALL) -m 644 $(LIBSONAMEFULL) $(DESTDIR)$(libdir)
	$(LNK)  $(LIBSONAMEFULL) $(DESTDIR)$(libdir)/$(LIBSONAME)
	$(LNK)  $(LIBSONAMEFULL) $(DESTDIR)$(libdir)/$(LIBSO)
	$(INSTALL) -m 644 $(LIB_MONI_NAME) $(DESTDIR)$(libdir)
	$(INSTALL) -m 644 $(LIB_MONI_SONAMEFULL) $(DESTDIR)$(libdir)
	$(LNK)  $(LIB_MONI_SONAMEFULL) $(DESTDIR)$(libdir)/$(LIB_MONI_SONAME)
	$(LNK)  $(LIB_MONI_SONAMEFULL) $(DESTDIR)$(libdir)/$(LIB_MONI_SO)
	test -d $(DESTDIR)$(includedir)/$(TARGET) || mkdir -p $(DESTDIR)$(includedir)/$(TARGET)
	$(INSTALL) -m 644 $(TARGET).h $(DESTDIR)$(includedir)/$(TARGET)
	$(INSTALL) -m 644 $(TARGET)_config.h $(DESTDIR)$(includedir)/$(TARGET)
	$(INSTALL) -m 644 $(TARGET)_definitions.h $(DESTDIR)$(includedir)/$(TARGET)
	$(INSTALL) -m 644 $(TARGET)_monitor.h $(DESTDIR)$(includedir)/$(TARGET)
	test "$(FLTK_GUI)" && $(MAKE) install_gui || echo -e "GUI not installed"
	echo Installing policy settings files ...
	-mkdir -p $(DESTDIR)$(colordir)/settings
	-$(INSTALL) -m 644 settings/*.policy.xml $(DESTDIR)$(colordir)/settings
	echo ... Installation finished

# install recursive
install:	install-main
	cd standard_profiles; \
	for prof in $(STD_PROFILES); do \
	     test $${prof} && \
	         (cd $${prof}; $(MAKE) DESTDIR=$(DESTDIR) install) || \
	         echo -e "$${prof} profile directory is not found - ignoring"; \
	done;

install_gui:	$(TARGET)-config-fltk
	echo Installing UI ...
	-$(MAKE)  $(TARGET)-config-flu 
	mkdir -p $(DESTDIR)$(bindir)
	-$(INSTALL) -m 755 $(TARGET)-config-flu $(DESTDIR)$(bindir)
	$(INSTALL) -m 755 $(TARGET)-config-fltk $(DESTDIR)$(bindir)

# build a source distribution package
dist: targz
	test -d ../Archiv && $(COPY) ../Archiv/$(TARGET)-$(MTIME).tgz $(TARGET)-$(VERSION).tar.gz || $(COPY) $(TARGET)-$(MTIME).tgz $(TARGET)-$(VERSION).tar.gz

# build a binary rpm package
rpm:	dist
	mkdir -p rpmdir/BUILD \
	rpmdir/SPECS \
	rpmdir/SOURCES \
	rpmdir/SRPMS \
	rpmdir/RPMS/$(RPMARCH)
	cd standard_profiles; \
	for prof in $(STD_PROFILES); do \
	     test $${prof} && \
	         (cd $${prof}; echo bin in `pwd`; $(MAKE) rpm) || \
	         echo -e "$${prof} profile directory is not found - ignoring"; \
	done;
	cp -f $(TARGET)-$(VERSION).tar.gz rpmdir/SOURCES
	rpmbuild --clean -ba $(srcdir)/$(TARGET).spec --define "_topdir $$PWD/rpmdir"
	@echo "============================================================"
	@echo "Finished - the packages are in rpmdir/RPMS and rpmdir/SRPMS!"

# remove everything previously installed
uninstall:
	echo Uninstalling ...
	$(RM)   $(DESTDIR)$(bindir)/$(TARGET)-monitor
	$(RM)   $(DESTDIR)$(bindir)/$(TARGET)-config
	$(RM)   $(DESTDIR)$(bindir)/$(TARGET)-config-flu
	$(RM)   $(DESTDIR)$(bindir)/$(TARGET)-config-fltk
	-$(RM)   $(DESTDIR)$(bindir)/$(TARGET)-monitor-nvidia
	$(RM)   $(DESTDIR)$(libdir)/pkgconfig/$(TARGET).pc
	$(RM)   $(DESTDIR)$(libdir)/pkgconfig/$(TARGET)_monitor.pc
	$(RM)   $(DESTDIR)$(libdir)/$(LIBSONAMEFULL) \
	        $(DESTDIR)$(libdir)/$(LIBSONAME) \
	        $(DESTDIR)$(libdir)/$(LIBSO) \
			$(DESTDIR)$(libdir)/$(LIBNAME)
	$(RM)   $(DESTDIR)$(libdir)/$(LIB_MONI_SONAMEFULL) \
	        $(DESTDIR)$(libdir)/$(LIB_MONI_SONAME) \
			$(DESTDIR)$(libdir)/$(LIB_MONI_SO) \
	        $(DESTDIR)$(libdir)/$(LIB_MONI_NAME)
	$(RM)   -R $(DESTDIR)$(includedir)/$(TARGET)
	test -d standard_profiles && \
	(  cd standard_profiles; \
	   for prof in $(STD_PROFILES); do \
	     test $${prof} && \
	         (cd $${prof}; $(MAKE) uninstall) || \
	         echo -e "$${prof} profile directory is not found - ignoring"; \
	   done; \
        ) || echo "no profile directory found"
	-$(RM)   $(DESTDIR)$(colordir)/settings/*.policy.xml

# remove in this directory
clean:
	$(RM) \
	$(OBJECTS) $(MONI_OBJECTS) \
	$(LIBNAME) $(LIBSONAMEFULL) $(LIBSONAME) $(LIB_SO) \
	$(LIB_MONI_NAME) $(LIB_MONI_SONAME) $(LIB_MONI_SO) $(LIB_MONI_SONAMEFULL) \
	$(TARGET)_gamma.o $(TARGET)-monitor $(TARGET)-monitor-nvidia \
	test2.o test.o test2 test \
	$(TARGET)-config-fltk $(FLTK_OBJECTS) \
	$(TARGET)-config-flu $(FLU_OBJECTS)
	-(cd $(LIB_XNVCTRL) && $(MAKE) clean)

# configure if the file config is not available
config:
	./configure

# try to resolve dependencies with the X11 tool
depend:
	echo "setting up dependencies ..."
	echo "MAKEDEPEND_ISUP = 1" > mkdepend
	$(MAKEDEPEND) -f mkdepend \
	-s "# dont edit - automatically generated" \
	-I. $(INCL_DEP)


# Build commands and filename extensions...
.SUFFIXES:	.0 .1 .3 .c .cxx .h .fl .man .o .z


.c.o:
	echo Compiling $< ...
	$(CC) -I.. $(CFLAGS) -c $<

.cxx.o:
	echo Compiling $< ...
	$(CXX) -I.. $(CXXFLAGS) -c $<

.cpp.o:	mkdepend
	echo Compiling $< ...
	$(CXX) -I.. $(CXXFLAGS) -c $<

.fl.cxx:
	echo Expanding $< ...
	fluid -c $<

.po:
	echo Generating $@ ...
	msgfmt $<


# smallest package covering the current directory
tgz:
	$(MAKE) DESTDIR=Entwickeln copy_files
	tar cf - Entwickeln/ \
	| gzip > $(TARGET)_$(MTIME).tgz
	test -d ../Archiv && mv -v $(TARGET)_*.tgz ../Archiv
	test -d Entwickeln && \
	test `pwd` != `(cd Entwickeln; pwd)` && \
	rm -R Entwickeln

# build the source package including the subdirectories
targz:
	test -d $(TARGET)-$(VERSION) && $(RM) -R $(TARGET)-$(VERSION) || echo -e "\c"
	$(MAKE) DESTDIR=$(TARGET)-$(VERSION) copy_files
	cd standard_profiles; \
	for prof in $(STD_PROFILES); do \
	     test $${prof} && \
	         mkdir -p ../$(TARGET)-$(VERSION)/standard_profiles/$${prof}; \
	         (cd $${prof}; echo bin in `pwd`; make DESTDIR=../../$(TARGET)-$(VERSION)/standard_profiles/$${prof} copy_files) || \
	         echo -e "$${prof} profile directory is not found - ignoring"; \
	done;
	tar cf - $(TARGET)-$(VERSION)/ \
	| gzip > $(TARGET)-$(MTIME).tgz
	test -d $(TARGET)-$(VERSION) && \
	test `pwd` != `(cd $(TARGET)-$(VERSION); pwd)` && \
	$(RM) -R $(TARGET)-$(VERSION)
	test -d ../Archiv && mv -v $(TARGET)-*.tgz ../Archiv || echo "no copy"

# basic file set
copy_files:
	mkdir $(DESTDIR)
	$(COPY) -R \
	$(ALL_FILES) \
	$(DESTDIR)
	$(COPY) -r settings $(DESTDIR)
	-(cd $(LIB_XNVCTRL) && $(MAKE) clean)
	$(COPY) -R $(LIB_XNVCTRL) $(DESTDIR)

# mkdepend
#include mkdepend

#ifndef MAKEDEPEND_ISUP
mkdepend: depend
#endif

