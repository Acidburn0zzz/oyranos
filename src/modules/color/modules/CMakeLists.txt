# --- dependencies ---

# --- variables ---

# --- normal modules ---
IF( HAVE_LCMS )
  SET( OY_MODULE lcms )
  SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} )
  SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
  ADD_LIBRARY( ${OY_MODULE_LIB}
               SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
  TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
# ${LCMS_LIBRARIES}
  INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
  IF(ENABLE_STATIC_LIBS AND NOT HAVE_LCMS2)
    # lcms 1 and lcms 2 APIs are too close to handle safely in a static library; just use the later
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
  ENDIF(ENABLE_STATIC_LIBS)
ENDIF( HAVE_LCMS )

IF( HAVE_LCMS2 )
  SET( OY_MODULE lcm2 )
  SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} )
  SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
  ADD_LIBRARY( ${OY_MODULE_LIB}
               SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
  TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
# ${LCMS2_LIBRARIES}
  INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
  IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
  ENDIF(ENABLE_STATIC_LIBS)
ENDIF()


IF( HAVE_LIBRAW_PLUGIN )
  SET( OY_MODULE lraw )
  SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} ${LIBRAW_LIBRARIES} ${EXIF_LIBRARIES} )
  SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
  ADD_LIBRARY( ${OY_MODULE_LIB}
               SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.cpp )
  TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
  INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
  SET( OY_MODULE_LIBRARIES ${OY_MODULE_LIBRARIES} ${MODULE_EXTRA_LIBS} )
  IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.cpp )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
  ENDIF(ENABLE_STATIC_LIBS)
ENDIF( HAVE_LIBRAW_PLUGIN )


SET( OY_MODULE oicc )
SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} )
SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
ADD_LIBRARY( ${OY_MODULE_LIB}
             SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
ENDIF(ENABLE_STATIC_LIBS)


IF( HAVE_LIBPNG )
  SET( OY_MODULE oPNG )
  FIND_LIBRARY( ZLIB_LIBRARIES NAMES z )
  IF( ZLIB_LIBRARIES )
    SET( PNG_EXTRA_LIBS ${EXTRA_LIBS} ${ZLIB_LIBRARIES} )
  ENDIF( ZLIB_LIBRARIES )
  SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} ${LIBPNG_LIBRARIES} ${PNG_EXTRA_LIBS} )
  SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
  ADD_LIBRARY( ${OY_MODULE_LIB}
               SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
  TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
  INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
  SET( OY_MODULE_LIBRARIES ${OY_MODULE_LIBRARIES} ${MODULE_EXTRA_LIBS} )
  IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
  ENDIF(ENABLE_STATIC_LIBS)
ENDIF()

IF( HAVE_JPEG )
  SET( OY_MODULE oJPG )
  SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} ${JPEG_LIBRARY} )
  SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
  ADD_LIBRARY( ${OY_MODULE_LIB}
               SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.c jpegmarkers.c )
  TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
  INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
  SET( OY_MODULE_LIBRARIES ${OY_MODULE_LIBRARIES} ${MODULE_EXTRA_LIBS} )
  IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.c jpegmarkers.c )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
  ENDIF(ENABLE_STATIC_LIBS)
ENDIF()


SET( OY_MODULE oydi )
SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} ${XCM_LIBRARIES} ${XFIXES_LIBRARIES} )
SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
ADD_LIBRARY( ${OY_MODULE_LIB}
             SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
SET( OY_MODULE_LIBRARIES ${OY_MODULE_LIBRARIES} ${MODULE_EXTRA_LIBS} )
IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
ENDIF(ENABLE_STATIC_LIBS)

SET( OY_MODULE oyra )
SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} ${XCM_LIBRARIES} ${XFIXES_LIBRARIES} )
SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
ADD_LIBRARY( ${OY_MODULE_LIB}
             SHARED
             ${PACKAGE_NAME}_cmm_${OY_MODULE}.c
             ${PACKAGE_NAME}_cmm_${OY_MODULE}_image.c
             ${PACKAGE_NAME}_cmm_${OY_MODULE}_image_channel.c
             ${PACKAGE_NAME}_cmm_${OY_MODULE}_image_expose.c
             ${PACKAGE_NAME}_cmm_${OY_MODULE}_image_scale.c
             ${PACKAGE_NAME}_cmm_${OY_MODULE}_image_ppm.c
           )
TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
SET( OY_MODULE_LIBRARIES ${OY_MODULE_LIBRARIES} ${MODULE_EXTRA_LIBS} )
IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC
                 ${PACKAGE_NAME}_cmm_${OY_MODULE}.c
                 ${PACKAGE_NAME}_cmm_${OY_MODULE}_image.c
                 ${PACKAGE_NAME}_cmm_${OY_MODULE}_image_channel.c
                 ${PACKAGE_NAME}_cmm_${OY_MODULE}_image_expose.c
                 ${PACKAGE_NAME}_cmm_${OY_MODULE}_image_scale.c
                 ${PACKAGE_NAME}_cmm_${OY_MODULE}_image_ppm.c
               )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
ENDIF(ENABLE_STATIC_LIBS)

# threads handler
IF( HAVE_PTHREAD )
  SET( OY_MODULE trds )
  SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} ${THREAD_LIBRARY} )
  SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
  ADD_LIBRARY( ${OY_MODULE_LIB}
               SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
  TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
  INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
  SET( OY_MODULE_LIBRARIES ${OY_MODULE_LIBRARIES} ${MODULE_EXTRA_LIBS} )
  IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
  ENDIF(ENABLE_STATIC_LIBS)
ENDIF( HAVE_PTHREAD )

# DB handler
IF( HAVE_OPENICC )
  SET( OY_MODULE oiDB )
  SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} ${OPENICC_LIBRARY} )
  SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
  ADD_LIBRARY( ${OY_MODULE_LIB}
               SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
  TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
  INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
  SET( OY_MODULE_LIBRARIES ${OY_MODULE_LIBRARIES} ${MODULE_EXTRA_LIBS} )
  IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
  ENDIF(ENABLE_STATIC_LIBS)
ENDIF( HAVE_OPENICC )

IF( HAVE_ELEKTRA )
  SET( OY_MODULE elDB )
  IF( ${CMAKE_SYSTEM_NAME} MATCHES Windows)
    # currently (Elektra-0.8.9) only a statically linked elektra works for Oyranos
    SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} ${ELEKTRA_LDFLAGS} elektra-full )
  ELSE()
    SET( MODULE_EXTRA_LIBS ${EXTRA_LIBS} ${ELEKTRA_LDFLAGS} )
  ENDIF()
  SET( OY_MODULE_LIB ${PACKAGE_NAME}_${OY_MODULE}${OY_MODULE_NAME} )
  ADD_LIBRARY( ${OY_MODULE_LIB}
               SHARED ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
  TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB} ${PROJECT_NAME} ${MODULE_EXTRA_LIBS} )
  INSTALL (TARGETS ${OY_MODULE_LIB} DESTINATION ${CMAKE_INSTALL_LIBDIR}/${OY_CMMSUBPATH})
  SET( OY_MODULE_LIBRARIES ${OY_MODULE_LIBRARIES} ${MODULE_EXTRA_LIBS} )
  IF(ENABLE_STATIC_LIBS)
    ADD_LIBRARY( ${OY_MODULE_LIB}-static
                 STATIC ${PACKAGE_NAME}_cmm_${OY_MODULE}.c )
    TARGET_LINK_LIBRARIES ( ${OY_MODULE_LIB}-static ${PACKAGE_NAME}-static ${MODULE_EXTRA_LIBS} )
    SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} ${OY_MODULE_LIB}-static )
  ENDIF(ENABLE_STATIC_LIBS)
ENDIF( HAVE_ELEKTRA )

# --- device modules ---

ADD_SUBDIRECTORY (devices)

SET( OY_MODULE_STATIC ${OY_MODULE_STATIC} PARENT_SCOPE )
SET( OY_MODULE_LIBRARIES ${OY_MODULE_LIBRARIES} PARENT_SCOPE )
